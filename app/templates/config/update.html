{% extends "base.html" %}

{% block title %}更新配置{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-sync-alt me-2"></i>更新配置
                </h1>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('config.config_management') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>返回配置管理
                    </a>
                    <button class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-1"></i>保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="updateConfigForm" method="POST" action="{{ url_for('config.save_update_config') }}">
        <div class="row">
            <!-- 版本信息 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>版本信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="current_version" class="form-label">当前版本</label>
                            <input type="text" class="form-control" id="current_version" 
                                   name="current_version" value="{{ config_data.version_info.current_version or '1.0.0' }}" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="latest_version" class="form-label">最新版本</label>
                            <input type="text" class="form-control" id="latest_version" 
                                   name="latest_version" value="{{ config_data.version_info.latest_version or '1.0.0' }}">
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="update_available" 
                                   name="update_available" {% if config_data.version_info.update_available %}checked{% endif %}>
                            <label class="form-check-label" for="update_available">
                                有可用更新
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="force_update" 
                                   name="force_update" {% if config_data.version_info.force_update %}checked{% endif %}>
                            <label class="form-check-label" for="force_update">
                                强制更新
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 更新设置 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>更新设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto_update" 
                                   name="auto_update" {% if config_data.update_settings.auto_update %}checked{% endif %}>
                            <label class="form-check-label" for="auto_update">
                                自动更新
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="check_interval" class="form-label">检查间隔（秒）</label>
                            <input type="number" class="form-control" id="check_interval" 
                                   name="check_interval" value="{{ config_data.update_settings.update_check_interval or 1800 }}" 
                                   min="60" max="86400">
                        </div>
                        
                        <div class="mb-3">
                            <label for="download_timeout" class="form-label">下载超时（秒）</label>
                            <input type="number" class="form-control" id="download_timeout" 
                                   name="download_timeout" value="{{ config_data.update_settings.download_timeout or 600 }}" 
                                   min="30" max="3600">
                        </div>
                        
                        <div class="mb-3">
                            <label for="retry_count" class="form-label">重试次数</label>
                            <input type="number" class="form-control" id="retry_count" 
                                   name="retry_count" value="{{ config_data.update_settings.retry_count or 5 }}" 
                                   min="0" max="10">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 更新渠道 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-broadcast-tower me-2"></i>更新渠道
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 稳定版渠道 -->
                        <div class="mb-3">
                            <h6>稳定版渠道</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="stable_enabled" 
                                       name="stable_enabled" {% if config_data.update_channels.stable.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="stable_enabled">
                                    启用稳定版渠道
                                </label>
                            </div>
                            <input type="url" class="form-control mb-2" name="stable_url" 
                                   value="{{ config_data.update_channels.stable.url or 'https://update.example.com/stable' }}" 
                                   placeholder="稳定版更新URL">
                            <input type="number" class="form-control" name="stable_priority" 
                                   value="{{ config_data.update_channels.stable.priority or 1 }}" 
                                   placeholder="优先级" min="1" max="10">
                        </div>
                        
                        <!-- 测试版渠道 -->
                        <div class="mb-3">
                            <h6>测试版渠道</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="beta_enabled" 
                                       name="beta_enabled" {% if config_data.update_channels.beta.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="beta_enabled">
                                    启用测试版渠道
                                </label>
                            </div>
                            <input type="url" class="form-control mb-2" name="beta_url" 
                                   value="{{ config_data.update_channels.beta.url or 'https://update.example.com/beta' }}" 
                                   placeholder="测试版更新URL">
                            <input type="number" class="form-control" name="beta_priority" 
                                   value="{{ config_data.update_channels.beta.priority or 2 }}" 
                                   placeholder="优先级" min="1" max="10">
                        </div>
                        
                        <!-- 开发版渠道 -->
                        <div class="mb-3">
                            <h6>开发版渠道</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="alpha_enabled" 
                                       name="alpha_enabled" {% if config_data.update_channels.alpha.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="alpha_enabled">
                                    启用开发版渠道
                                </label>
                            </div>
                            <input type="url" class="form-control mb-2" name="alpha_url" 
                                   value="{{ config_data.update_channels.alpha.url or 'https://update.example.com/alpha' }}" 
                                   placeholder="开发版更新URL">
                            <input type="number" class="form-control" name="alpha_priority" 
                                   value="{{ config_data.update_channels.alpha.priority or 3 }}" 
                                   placeholder="优先级" min="1" max="10">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 回滚设置 -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-undo me-2"></i>回滚设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="rollback_enabled" 
                                   name="rollback_enabled" {% if config_data.rollback_settings.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="rollback_enabled">
                                启用回滚功能
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="keep_versions" class="form-label">保留版本数量</label>
                            <input type="number" class="form-control" id="keep_versions" 
                                   name="keep_versions" value="{{ config_data.rollback_settings.keep_versions or 5 }}" 
                                   min="1" max="20">
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto_rollback" 
                                   name="auto_rollback" {% if config_data.rollback_settings.auto_rollback_on_error %}checked{% endif %}>
                            <label class="form-check-label" for="auto_rollback">
                                错误时自动回滚
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- 配置信息 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-primary" onclick="saveConfig()">
                            <i class="fas fa-save me-1"></i>保存配置
                        </button>
                        <button class="btn btn-secondary" onclick="resetConfig()">
                            <i class="fas fa-undo me-1"></i>重置配置
                        </button>
                        <button class="btn btn-info" onclick="previewConfig()">
                            <i class="fas fa-eye me-1"></i>预览配置
                        </button>
                        <a href="{{ url_for('config.update_default_config') }}" class="btn btn-warning">
                            <i class="fas fa-history me-1"></i>查看默认配置
                        </a>
                    </div>
                    <hr>
                    <small class="text-muted">
                        最后检查时间：{{ config_data.last_checked or '未知' }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function saveConfig() {
    document.getElementById('updateConfigForm').submit();
}

function resetConfig() {
    if (confirm('确定要重置所有配置到默认值吗？')) {
        location.reload();
    }
}

function previewConfig() {
    const formData = new FormData(document.getElementById('updateConfigForm'));
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        config[key] = value;
    }
    
    alert('配置预览：\n' + JSON.stringify(config, null, 2));
}
</script>
{% endblock %}
